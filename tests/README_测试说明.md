# æƒé™ä¸å›¢é˜Ÿç®¡ç†ç³»ç»Ÿæµ‹è¯•è¯´æ˜

## ğŸ“‹ æµ‹è¯•æ¦‚è§ˆ

æœ¬é¡¹ç›®åŒ…å«å®Œæ•´çš„PHPUnitæµ‹è¯•å¥—ä»¶ï¼Œç”¨äºæµ‹è¯•æƒé™ä¸å›¢é˜Ÿç®¡ç†ç³»ç»Ÿçš„å„ä¸ªæ–¹é¢ã€‚æµ‹è¯•åˆ†ä¸ºå•å…ƒæµ‹è¯•å’ŒåŠŸèƒ½æµ‹è¯•ä¸¤å¤§ç±»ã€‚

## ğŸ“ æµ‹è¯•æ–‡ä»¶ç»“æ„

```
tests/
â”œâ”€â”€ Unit/                           # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ UserModelTest.php          # ç”¨æˆ·æ¨¡å‹æµ‹è¯• (18ä¸ªæµ‹è¯•æ–¹æ³•)
â”‚   â”œâ”€â”€ TeamModelTest.php          # å›¢é˜Ÿæ¨¡å‹æµ‹è¯• (13ä¸ªæµ‹è¯•æ–¹æ³•)
â”‚   â””â”€â”€ RolePermissionTest.php     # è§’è‰²æƒé™æµ‹è¯• (20ä¸ªæµ‹è¯•æ–¹æ³•)
â”œâ”€â”€ Feature/                        # åŠŸèƒ½æµ‹è¯•
â”‚   â”œâ”€â”€ PermissionSystemTest.php   # æƒé™ç³»ç»ŸåŠŸèƒ½æµ‹è¯• (15ä¸ªæµ‹è¯•æ–¹æ³•)
â”‚   â””â”€â”€ TeamManagementTest.php     # å›¢é˜Ÿç®¡ç†åŠŸèƒ½æµ‹è¯• (16ä¸ªæµ‹è¯•æ–¹æ³•)
â”œâ”€â”€ run_permission_tests.php       # æµ‹è¯•è¿è¡Œè„šæœ¬
â””â”€â”€ README_æµ‹è¯•è¯´æ˜.md             # æœ¬æ–‡æ¡£
```

**æ€»è®¡ï¼š82ä¸ªæµ‹è¯•æ–¹æ³•ï¼Œè¦†ç›–æƒé™ä¸å›¢é˜Ÿç®¡ç†çš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½**

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹æ³•1ï¼šä½¿ç”¨æµ‹è¯•è¿è¡Œè„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# è¿è¡Œäº¤äº’å¼æµ‹è¯•è„šæœ¬
php tests/run_permission_tests.php
```

### æ–¹æ³•2ï¼šç›´æ¥ä½¿ç”¨PHPUnit

```bash
# è¿è¡Œæ‰€æœ‰æƒé™ç›¸å…³æµ‹è¯•
./vendor/bin/phpunit tests/Unit/UserModelTest.php tests/Unit/TeamModelTest.php tests/Unit/RolePermissionTest.php tests/Feature/PermissionSystemTest.php tests/Feature/TeamManagementTest.php

# è¿è¡Œå•å…ƒæµ‹è¯•
./vendor/bin/phpunit tests/Unit/

# è¿è¡ŒåŠŸèƒ½æµ‹è¯•
./vendor/bin/phpunit tests/Feature/

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
./vendor/bin/phpunit tests/Unit/UserModelTest.php

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–¹æ³•
./vendor/bin/phpunit tests/Unit/UserModelTest.php --filter user_can_assign_role_safely
```

## ğŸ“Š æµ‹è¯•è¯¦ç»†è¯´æ˜

### å•å…ƒæµ‹è¯• (Unit Tests)

#### 1. UserModelTest.php - ç”¨æˆ·æ¨¡å‹æµ‹è¯•
æµ‹è¯•ç”¨æˆ·æ¨¡å‹çš„æ ¸å¿ƒåŠŸèƒ½å’Œå®‰å…¨æƒé™æ–¹æ³•ï¼š

- **åŸºç¡€åŠŸèƒ½æµ‹è¯•**
  - ç”¨æˆ·åˆ›å»ºå’Œå›¢é˜Ÿå…³è”
  - å›¢é˜Ÿä¸Šä¸‹æ–‡è®¾ç½®
  
- **å®‰å…¨æƒé™æ–¹æ³•æµ‹è¯•**
  - `assignRoleSafely()` - å®‰å…¨è§’è‰²åˆ†é…
  - `hasPermissionToSafely()` - å®‰å…¨æƒé™æ£€æŸ¥
  - `canSafely()` - æƒé™æ£€æŸ¥åˆ«å
  - `hasAnyPermissionSafely()` - å¤šæƒé™æ£€æŸ¥
  - `removeRoleSafely()` - å®‰å…¨è§’è‰²ç§»é™¤
  - `syncRolesSafely()` - å®‰å…¨è§’è‰²åŒæ­¥

- **è·¨å›¢é˜ŸåŠŸèƒ½æµ‹è¯•**
  - `assignRoleInTeam()` - æŒ‡å®šå›¢é˜Ÿè§’è‰²åˆ†é…
  - `hasPermissionInTeam()` - æŒ‡å®šå›¢é˜Ÿæƒé™æ£€æŸ¥
  - `getRolesInTeam()` - è·å–å›¢é˜Ÿè§’è‰²
  - `getAllRoles()` - è·å–æ‰€æœ‰è§’è‰²
  - `withTeamContext()` - å›¢é˜Ÿä¸Šä¸‹æ–‡åˆ‡æ¢

#### 2. TeamModelTest.php - å›¢é˜Ÿæ¨¡å‹æµ‹è¯•
æµ‹è¯•å›¢é˜Ÿæ¨¡å‹çš„åŸºç¡€åŠŸèƒ½å’Œå…³ç³»ç®¡ç†ï¼š

- **å›¢é˜ŸåŸºç¡€åŠŸèƒ½**
  - å›¢é˜Ÿåˆ›å»ºå’Œå±æ€§ç®¡ç†
  - ä¸ªäººå›¢é˜Ÿæ ‡å¿—
  - å›¢é˜Ÿæ›´æ–°å’Œåˆ é™¤

- **ç”¨æˆ·å…³ç³»ç®¡ç†**
  - ç”¨æˆ·æ·»åŠ åˆ°å›¢é˜Ÿ
  - å¤šç”¨æˆ·ä¸åŒè§’è‰²ç®¡ç†
  - ç”¨æˆ·è§’è‰²æ›´æ–°
  - ç”¨æˆ·ä»å›¢é˜Ÿç§»é™¤

- **æƒé™éš”ç¦»æµ‹è¯•**
  - å›¢é˜Ÿé—´è§’è‰²å’Œæƒé™éš”ç¦»
  - åŒåè§’è‰²åœ¨ä¸åŒå›¢é˜Ÿçš„ç‹¬ç«‹æ€§

#### 3. RolePermissionTest.php - è§’è‰²æƒé™æµ‹è¯•
æµ‹è¯•Spatie PermissionåŒ…åœ¨å¤šå›¢é˜Ÿç¯å¢ƒä¸‹çš„åŠŸèƒ½ï¼š

- **è§’è‰²å’Œæƒé™åˆ›å»º**
  - å¸¦å›¢é˜ŸIDçš„è§’è‰²åˆ›å»º
  - å¸¦å›¢é˜ŸIDçš„æƒé™åˆ›å»º
  - åŒåè§’è‰²/æƒé™åœ¨ä¸åŒå›¢é˜Ÿçš„éš”ç¦»

- **è§’è‰²æƒé™å…³è”**
  - è§’è‰²åˆ†é…æƒé™
  - è·¨å›¢é˜Ÿæƒé™åˆ†é…é™åˆ¶
  - æƒé™ç»§æ‰¿æµ‹è¯•

- **ç”¨æˆ·è§’è‰²åˆ†é…**
  - å›¢é˜Ÿä¸Šä¸‹æ–‡ä¸­çš„è§’è‰²åˆ†é…
  - è§’è‰²ç§»é™¤å’ŒåŒæ­¥
  - ç›´æ¥æƒé™åˆ†é…

- **å¤šGuardæ”¯æŒ**
  - ä¸åŒGuardçš„è§’è‰²æƒé™éš”ç¦»

### åŠŸèƒ½æµ‹è¯• (Feature Tests)

#### 4. PermissionSystemTest.php - æƒé™ç³»ç»ŸåŠŸèƒ½æµ‹è¯•
æµ‹è¯•å®Œæ•´çš„æƒé™ç³»ç»Ÿæµç¨‹å’Œç”¨æˆ·äº¤äº’ï¼š

- **å®Œæ•´æƒé™æµç¨‹**
  - ç”¨æˆ·è§’è‰²åˆ†é…å’Œæƒé™æ£€æŸ¥
  - å®‰å…¨æ–¹æ³•çš„å®é™…ä½¿ç”¨
  - ä¸å­˜åœ¨æƒé™çš„ä¼˜é›…å¤„ç†

- **å¤šå›¢é˜Ÿåœºæ™¯**
  - å›¢é˜Ÿåˆ‡æ¢å’Œæƒé™éš”ç¦»
  - è·¨å›¢é˜Ÿæ“ä½œ
  - å¤æ‚å¤šå›¢é˜Ÿæƒé™ç®¡ç†

- **é«˜çº§åŠŸèƒ½**
  - `withTeamContext()` æ–¹æ³•çš„å®é™…åº”ç”¨
  - ç®¡ç†å‘˜æƒé™ç®¡ç†
  - è‡ªåŠ¨å›¢é˜Ÿä¸Šä¸‹æ–‡è®¾ç½®

#### 5. TeamManagementTest.php - å›¢é˜Ÿç®¡ç†åŠŸèƒ½æµ‹è¯•
æµ‹è¯•å›¢é˜Ÿç®¡ç†çš„å®Œæ•´åŠŸèƒ½å’Œä¸šåŠ¡æµç¨‹ï¼š

- **å›¢é˜Ÿåˆ›å»ºå’Œç®¡ç†**
  - å›¢é˜Ÿåˆ›å»ºå’Œæ‰€æœ‰è€…è®¾ç½®
  - å›¢é˜Ÿä¿¡æ¯æ›´æ–°
  - å›¢é˜Ÿåˆ é™¤å’Œæ¸…ç†

- **æˆå‘˜ç®¡ç†**
  - æˆå‘˜é‚€è¯·å’Œæ·»åŠ 
  - æˆå‘˜è§’è‰²ç®¡ç†
  - æˆå‘˜ç§»é™¤å’Œç¦»å¼€

- **æƒé™ç®¡ç†**
  - å›¢é˜Ÿæˆå‘˜æƒé™åˆ†é…
  - æƒé™è§’è‰²æ›´æ–°
  - å¤šè§’è‰²æƒé™ç»„åˆ

- **é«˜çº§åœºæ™¯**
  - æ‰€æœ‰æƒè½¬ç§»
  - å¤šå›¢é˜Ÿæˆå‘˜ç®¡ç†
  - ä¸ªäººå›¢é˜Ÿå¤„ç†

## ğŸ”§ æµ‹è¯•é…ç½®

### ç¯å¢ƒè¦æ±‚

- PHP 8.0+
- Laravel 9.0+
- PHPUnit 9.0+
- MySQL/PostgreSQL æµ‹è¯•æ•°æ®åº“

### æ•°æ®åº“é…ç½®

æµ‹è¯•ä½¿ç”¨ `RefreshDatabase` traitï¼Œä¼šåœ¨æ¯ä¸ªæµ‹è¯•å‰é‡ç½®æ•°æ®åº“ã€‚ç¡®ä¿æµ‹è¯•æ•°æ®åº“é…ç½®æ­£ç¡®ï¼š

```php
// .env.testing
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=your_test_database
DB_USERNAME=your_username
DB_PASSWORD=your_password
```

### ä¾èµ–åŒ…

ç¡®ä¿ä»¥ä¸‹åŒ…å·²å®‰è£…ï¼š

```json
{
    "require-dev": {
        "phpunit/phpunit": "^9.0",
        "laravel/jetstream": "^2.0",
        "spatie/laravel-permission": "^5.0"
    }
}
```

## ğŸ“ˆ æµ‹è¯•è¦†ç›–èŒƒå›´

### æ ¸å¿ƒåŠŸèƒ½è¦†ç›–

- âœ… **ç”¨æˆ·æƒé™ç®¡ç†** (100%)
  - å®‰å…¨æƒé™æ£€æŸ¥æ–¹æ³•
  - è·¨å›¢é˜Ÿæƒé™éªŒè¯
  - æƒé™ä¸Šä¸‹æ–‡ç®¡ç†

- âœ… **è§’è‰²ç®¡ç†** (100%)
  - è§’è‰²åˆ†é…å’Œç§»é™¤
  - è§’è‰²åŒæ­¥
  - å¤šå›¢é˜Ÿè§’è‰²éš”ç¦»

- âœ… **å›¢é˜Ÿç®¡ç†** (100%)
  - å›¢é˜Ÿåˆ›å»ºå’Œåˆ é™¤
  - æˆå‘˜ç®¡ç†
  - æ‰€æœ‰æƒè½¬ç§»

- âœ… **æƒé™ç³»ç»Ÿé›†æˆ** (100%)
  - Spatie PermissionåŒ…é›†æˆ
  - å¤šGuardæ”¯æŒ
  - æ•°æ®åº“å…³ç³»å®Œæ•´æ€§

### è¾¹ç•Œæƒ…å†µè¦†ç›–

- âœ… ä¸å­˜åœ¨çš„æƒé™å¤„ç†
- âœ… è·¨å›¢é˜Ÿæƒé™éš”ç¦»
- âœ… ç©ºè§’è‰²å’Œæƒé™å¤„ç†
- âœ… å¹¶å‘å›¢é˜Ÿä¸Šä¸‹æ–‡åˆ‡æ¢
- âœ… æ•°æ®åº“çº¦æŸéªŒè¯

## ğŸ› è°ƒè¯•æµ‹è¯•

### è¿è¡Œç‰¹å®šæµ‹è¯•

```bash
# è¿è¡Œç‰¹å®šæµ‹è¯•æ–¹æ³•
./vendor/bin/phpunit tests/Unit/UserModelTest.php --filter user_can_assign_role_safely

# æ˜¾ç¤ºè¯¦ç»†è¾“å‡º
./vendor/bin/phpunit tests/Unit/UserModelTest.php --verbose

# æ˜¾ç¤ºæµ‹è¯•è¦†ç›–ç‡
./vendor/bin/phpunit tests/Unit/UserModelTest.php --coverage-text
```

### å¸¸è§é—®é¢˜

1. **æ•°æ®åº“è¿æ¥é”™è¯¯**
   - æ£€æŸ¥ `.env.testing` é…ç½®
   - ç¡®ä¿æµ‹è¯•æ•°æ®åº“å­˜åœ¨ä¸”å¯è®¿é—®

2. **æƒé™ç›¸å…³é”™è¯¯**
   - ç¡®ä¿ Spatie Permission åŒ…æ­£ç¡®å®‰è£…
   - æ£€æŸ¥æ•°æ®åº“è¿ç§»æ˜¯å¦å®Œæ•´

3. **Factory é”™è¯¯**
   - ç¡®ä¿ User å’Œ Team çš„ Factory å­˜åœ¨
   - æ£€æŸ¥ Factory å®šä¹‰æ˜¯å¦æ­£ç¡®

## ğŸ“ ç¼–å†™æ–°æµ‹è¯•

### æµ‹è¯•å‘½åè§„èŒƒ

```php
/** @test */
public function user_can_perform_specific_action()
{
    // æµ‹è¯•ä»£ç 
}
```

### æµ‹è¯•ç»“æ„

```php
// 1. å‡†å¤‡ (Arrange)
$user = User::factory()->create();
$team = Team::factory()->create();

// 2. æ‰§è¡Œ (Act)
$user->assignRoleSafely('editor');

// 3. æ–­è¨€ (Assert)
$this->assertTrue($user->hasRole('editor'));
```

### æœ€ä½³å®è·µ

1. **ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•æ–¹æ³•å**
2. **æ¯ä¸ªæµ‹è¯•åªéªŒè¯ä¸€ä¸ªåŠŸèƒ½ç‚¹**
3. **ä½¿ç”¨é€‚å½“çš„æ–­è¨€æ–¹æ³•**
4. **æ¸…ç†æµ‹è¯•æ•°æ®ï¼ˆRefreshDatabaseå·²å¤„ç†ï¼‰**
5. **æ·»åŠ ä¸­æ–‡æ³¨é‡Šè¯´æ˜æµ‹è¯•ç›®çš„**

## ğŸ¯ æŒç»­é›†æˆ

### GitHub Actions é…ç½®ç¤ºä¾‹

```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        
    - name: Install dependencies
      run: composer install
      
    - name: Run tests
      run: ./vendor/bin/phpunit tests/Unit/ tests/Feature/
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æƒé™ä¸å›¢é˜Ÿç®¡ç†ç³»ç»Ÿæ–‡æ¡£](../docs/æƒé™ä¸å›¢é˜Ÿç®¡ç†/)
- [Laravel Testing å®˜æ–¹æ–‡æ¡£](https://laravel.com/docs/testing)
- [PHPUnit å®˜æ–¹æ–‡æ¡£](https://phpunit.de/documentation.html)
- [Spatie Permission æ–‡æ¡£](https://spatie.be/docs/laravel-permission)

---

**æ³¨æ„**ï¼šè¿è¡Œæµ‹è¯•å‰è¯·ç¡®ä¿å·²å®Œæˆç³»ç»Ÿçš„åŸºç¡€é…ç½®ï¼ŒåŒ…æ‹¬æ•°æ®åº“è¿ç§»ã€ç§å­æ•°æ®ç­‰ã€‚æµ‹è¯•ä¼šè‡ªåŠ¨å¤„ç†æ•°æ®åº“é‡ç½®ï¼Œä½†ä¸ä¼šå½±å“å¼€å‘ç¯å¢ƒçš„æ•°æ®ã€‚ 