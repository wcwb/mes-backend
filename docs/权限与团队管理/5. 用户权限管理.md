# ç”¨æˆ·æƒé™ç®¡ç†

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†ç”¨æˆ·æƒé™ç®¡ç†çš„å„ç§æ“ä½œå’Œæœ€ä½³å®è·µã€‚

## ğŸ¯ æƒé™æ£€æŸ¥æ–¹æ³•

### åŸºæœ¬æƒé™æ£€æŸ¥

#### hasPermissionToSafely()
è¿™æ˜¯æ¨èçš„æƒé™æ£€æŸ¥æ–¹æ³•ï¼Œè§£å†³äº†å¤šå›¢é˜Ÿç¯å¢ƒä¸‹çš„æƒé™åç§°è§£æé—®é¢˜ã€‚

```php
// åŸºæœ¬ç”¨æ³•
$user = auth()->user();

// æ£€æŸ¥å•ä¸ªæƒé™
if ($user->hasPermissionToSafely('view_orders')) {
    echo "ç”¨æˆ·æœ‰æŸ¥çœ‹è®¢å•æƒé™";
}

// æ£€æŸ¥æƒé™å¯¹è±¡
$permission = Permission::findByName('view_orders');
if ($user->hasPermissionToSafely($permission)) {
    echo "ç”¨æˆ·æœ‰æŸ¥çœ‹è®¢å•æƒé™";
}

// æŒ‡å®šå®ˆå«
if ($user->hasPermissionToSafely('view_orders', 'api')) {
    echo "ç”¨æˆ·åœ¨APIå®ˆå«ä¸‹æœ‰æŸ¥çœ‹è®¢å•æƒé™";
}
```

#### canSafely()
Laravel Gate ç³»ç»Ÿçš„å®‰å…¨ç‰ˆæœ¬ï¼Œæ”¯æŒå¤šå›¢é˜Ÿç¯å¢ƒã€‚

```php
// åŸºæœ¬æƒé™æ£€æŸ¥
if ($user->canSafely('edit_products')) {
    echo "ç”¨æˆ·å¯ä»¥ç¼–è¾‘äº§å“";
}

// å¸¦å‚æ•°çš„æƒé™æ£€æŸ¥
if ($user->canSafely('edit_product', $product)) {
    echo "ç”¨æˆ·å¯ä»¥ç¼–è¾‘è¿™ä¸ªç‰¹å®šäº§å“";
}

// åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨
public function edit(Product $product)
{
    if (!auth()->user()->canSafely('edit_product', $product)) {
        abort(403, 'æ‚¨æ²¡æœ‰ç¼–è¾‘æ­¤äº§å“çš„æƒé™');
    }
    
    return view('products.edit', compact('product'));
}
```

### æ‰¹é‡æƒé™æ£€æŸ¥

#### hasAnyPermissionSafely()
é«˜æ•ˆåœ°æ£€æŸ¥å¤šä¸ªæƒé™ï¼Œé¿å…é‡å¤æŸ¥è¯¢ã€‚

```php
$permissions = ['view_orders', 'edit_orders', 'delete_orders'];

// æ£€æŸ¥æ˜¯å¦æ‹¥æœ‰ä»»æ„ä¸€ä¸ªæƒé™
if ($user->hasAnyPermissionSafely($permissions)) {
    echo "ç”¨æˆ·è‡³å°‘æœ‰ä¸€ä¸ªè®¢å•ç›¸å…³æƒé™";
}

// æ£€æŸ¥æ˜¯å¦æ‹¥æœ‰æ‰€æœ‰æƒé™
if ($user->hasAnyPermissionSafely($permissions, true)) {
    echo "ç”¨æˆ·æ‹¥æœ‰æ‰€æœ‰è®¢å•æƒé™";
}

// å®é™…åº”ç”¨ç¤ºä¾‹
public function orderDashboard()
{
    $user = auth()->user();
    $orderPermissions = ['view_orders', 'edit_orders', 'delete_orders'];
    
    if (!$user->hasAnyPermissionSafely($orderPermissions)) {
        abort(403, 'æ‚¨æ²¡æœ‰è®¿é—®è®¢å•ç®¡ç†çš„æƒé™');
    }
    
    $canView = $user->hasPermissionToSafely('view_orders');
    $canEdit = $user->hasPermissionToSafely('edit_orders');
    $canDelete = $user->hasPermissionToSafely('delete_orders');
    
    return view('orders.dashboard', compact('canView', 'canEdit', 'canDelete'));
}
```

### è·¨å›¢é˜Ÿæƒé™æ£€æŸ¥

#### hasPermissionInTeam()
æ£€æŸ¥ç”¨æˆ·åœ¨æŒ‡å®šå›¢é˜Ÿä¸­çš„æƒé™ã€‚

```php
// æ£€æŸ¥ç”¨æˆ·åœ¨å›¢é˜Ÿ5ä¸­æ˜¯å¦æœ‰æŸ¥çœ‹è®¢å•æƒé™
if ($user->hasPermissionInTeam(5, 'view_orders')) {
    echo "ç”¨æˆ·åœ¨å›¢é˜Ÿ5æœ‰æŸ¥çœ‹è®¢å•æƒé™";
}

// ç®¡ç†å‘˜è·¨å›¢é˜Ÿæƒé™æ£€æŸ¥
public function adminOrderView($teamId, $orderId)
{
    $user = auth()->user();
    
    // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
    if (!$user->hasRole('super_admin')) {
        // æ£€æŸ¥æ˜¯å¦åœ¨æŒ‡å®šå›¢é˜Ÿæœ‰æƒé™
        if (!$user->hasPermissionInTeam($teamId, 'view_orders')) {
            abort(403, 'æ‚¨æ²¡æœ‰æŸ¥çœ‹è¯¥å›¢é˜Ÿè®¢å•çš„æƒé™');
        }
    }
    
    $order = Order::where('team_id', $teamId)->findOrFail($orderId);
    return view('orders.show', compact('order'));
}
```

## ğŸ”„ å›¢é˜Ÿä¸Šä¸‹æ–‡ç®¡ç†

### è‡ªåŠ¨å›¢é˜Ÿä¸Šä¸‹æ–‡

ç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨ç”¨æˆ·çš„ `current_team_id` ä½œä¸ºæƒé™ä¸Šä¸‹æ–‡ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹æ— éœ€æ‰‹åŠ¨è®¾ç½®ã€‚

```php
// ç”¨æˆ·ç™»å½•åï¼Œç³»ç»Ÿè‡ªåŠ¨è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡
$user = auth()->user();
echo "å½“å‰å›¢é˜Ÿ: " . $user->current_team_id;

// æƒé™æ£€æŸ¥è‡ªåŠ¨ä½¿ç”¨å½“å‰å›¢é˜Ÿä¸Šä¸‹æ–‡
if ($user->hasPermissionToSafely('view_orders')) {
    // æ£€æŸ¥ç”¨æˆ·åœ¨å½“å‰å›¢é˜Ÿçš„æƒé™
}
```

### æ‰‹åŠ¨è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½éœ€è¦æ‰‹åŠ¨è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡ã€‚

```php
// è®¾ç½®ç”¨æˆ·å½“å‰å›¢é˜Ÿä¸ºæƒé™ä¸Šä¸‹æ–‡
$user->setCurrentTeamAsPermissionContext();

// éªŒè¯è®¾ç½®æ˜¯å¦æˆåŠŸ
$registrar = app(\Spatie\Permission\PermissionRegistrar::class);
echo "æƒé™ä¸Šä¸‹æ–‡å›¢é˜ŸID: " . $registrar->getPermissionsTeamId();
```

### ä¸´æ—¶åˆ‡æ¢å›¢é˜Ÿä¸Šä¸‹æ–‡

ä½¿ç”¨ `withTeamContext()` æ–¹æ³•ä¸´æ—¶åˆ‡æ¢åˆ°æŒ‡å®šå›¢é˜Ÿæ‰§è¡Œæ“ä½œã€‚

```php
// åœ¨å›¢é˜Ÿ7ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œæ“ä½œ
$result = $user->withTeamContext(7, function($user) {
    // æ£€æŸ¥å›¢é˜Ÿ7çš„æƒé™
    $hasViewPermission = $user->hasPermissionToSafely('view_orders');
    $hasEditPermission = $user->hasPermissionToSafely('edit_orders');
    
    // è·å–å›¢é˜Ÿ7çš„è§’è‰²
    $roles = $user->roles;
    
    return [
        'can_view' => $hasViewPermission,
        'can_edit' => $hasEditPermission,
        'roles' => $roles->pluck('name')->toArray()
    ];
});

// æ“ä½œå®Œæˆåï¼Œå›¢é˜Ÿä¸Šä¸‹æ–‡è‡ªåŠ¨æ¢å¤
echo "å›¢é˜Ÿ7æƒé™æ£€æŸ¥ç»“æœ: " . json_encode($result);
```

## ğŸ“Š æƒé™æŸ¥è¯¢å’Œåˆ†æ

### è·å–ç”¨æˆ·æƒé™åˆ—è¡¨

```php
// è·å–ç”¨æˆ·åœ¨å½“å‰å›¢é˜Ÿçš„æ‰€æœ‰æƒé™
$permissions = $user->getAllPermissions();
foreach ($permissions as $permission) {
    echo "æƒé™: {$permission->name} (å›¢é˜Ÿ: {$permission->team_id})";
}

// è·å–æƒé™åç§°æ•°ç»„
$permissionNames = $user->getAllPermissions()->pluck('name')->toArray();
echo "æƒé™åˆ—è¡¨: " . implode(', ', $permissionNames);

// æŒ‰æ¨¡å—åˆ†ç»„æƒé™
$permissionsByModule = [];
foreach ($permissions as $permission) {
    $module = explode('_', $permission->name)[1] ?? 'other'; // å‡è®¾æƒé™æ ¼å¼ä¸º action_module
    $permissionsByModule[$module][] = $permission->name;
}
```

### æƒé™ç»Ÿè®¡å’Œåˆ†æ

```php
// åˆ›å»ºæƒé™åˆ†ææœåŠ¡
class PermissionAnalysisService
{
    public function getUserPermissionSummary(User $user): array
    {
        $allRoles = $user->getAllRoles();
        $summary = [];
        
        foreach ($allRoles as $role) {
            $teamId = $role->pivot_team_id;
            if (!isset($summary[$teamId])) {
                $summary[$teamId] = [
                    'team_id' => $teamId,
                    'roles' => [],
                    'permissions' => []
                ];
            }
            
            $summary[$teamId]['roles'][] = $role->name;
            
            // è·å–è§’è‰²æƒé™
            $rolePermissions = $role->permissions->pluck('name')->toArray();
            $summary[$teamId]['permissions'] = array_unique(
                array_merge($summary[$teamId]['permissions'], $rolePermissions)
            );
        }
        
        return $summary;
    }
    
    public function getPermissionMatrix(User $user): array
    {
        $modules = ['orders', 'products', 'customers', 'reports']; // ç³»ç»Ÿæ¨¡å—
        $actions = ['view', 'create', 'edit', 'delete', 'approve']; // æ“ä½œç±»å‹
        
        $matrix = [];
        foreach ($modules as $module) {
            $matrix[$module] = [];
            foreach ($actions as $action) {
                $permissionName = "{$action}_{$module}";
                $matrix[$module][$action] = $user->hasPermissionToSafely($permissionName);
            }
        }
        
        return $matrix;
    }
}

// ä½¿ç”¨æƒé™åˆ†ææœåŠ¡
$analysisService = new PermissionAnalysisService();

// è·å–ç”¨æˆ·æƒé™æ‘˜è¦
$summary = $analysisService->getUserPermissionSummary($user);
foreach ($summary as $teamData) {
    echo "å›¢é˜Ÿ {$teamData['team_id']}:\n";
    echo "  è§’è‰²: " . implode(', ', $teamData['roles']) . "\n";
    echo "  æƒé™æ•°é‡: " . count($teamData['permissions']) . "\n";
}

// è·å–æƒé™çŸ©é˜µ
$matrix = $analysisService->getPermissionMatrix($user);
foreach ($matrix as $module => $actions) {
    echo "æ¨¡å— {$module}:\n";
    foreach ($actions as $action => $hasPermission) {
        echo "  {$action}: " . ($hasPermission ? 'âœ“' : 'âœ—') . "\n";
    }
}
```

## ğŸ›¡ï¸ æƒé™éªŒè¯æ¨¡å¼

### ä¸­é—´ä»¶æƒé™éªŒè¯

```php
// åˆ›å»ºæƒé™éªŒè¯ä¸­é—´ä»¶
class CheckPermission
{
    public function handle($request, Closure $next, $permission)
    {
        $user = auth()->user();
        
        if (!$user) {
            abort(401, 'è¯·å…ˆç™»å½•');
        }
        
        if (!$user->current_team_id) {
            abort(403, 'è¯·å…ˆé€‰æ‹©å›¢é˜Ÿ');
        }
        
        if (!$user->hasPermissionToSafely($permission)) {
            abort(403, "æ‚¨æ²¡æœ‰ '{$permission}' æƒé™");
        }
        
        return $next($request);
    }
}

// åœ¨è·¯ç”±ä¸­ä½¿ç”¨
Route::middleware(['auth', 'permission:view_orders'])->group(function () {
    Route::get('/orders', [OrderController::class, 'index']);
    Route::get('/orders/{order}', [OrderController::class, 'show']);
});

// åœ¨æ§åˆ¶å™¨æ„é€ å‡½æ•°ä¸­ä½¿ç”¨
class OrderController extends Controller
{
    public function __construct()
    {
        $this->middleware('permission:view_orders')->only(['index', 'show']);
        $this->middleware('permission:create_orders')->only(['create', 'store']);
        $this->middleware('permission:edit_orders')->only(['edit', 'update']);
        $this->middleware('permission:delete_orders')->only(['destroy']);
    }
}
```

### ç­–ç•¥æƒé™éªŒè¯

```php
// åˆ›å»ºè®¢å•ç­–ç•¥
class OrderPolicy
{
    public function viewAny(User $user): bool
    {
        return $user->hasPermissionToSafely('view_orders');
    }
    
    public function view(User $user, Order $order): bool
    {
        // æ£€æŸ¥å›¢é˜Ÿæƒé™
        if ($user->current_team_id !== $order->team_id) {
            return false;
        }
        
        return $user->hasPermissionToSafely('view_orders');
    }
    
    public function create(User $user): bool
    {
        return $user->hasPermissionToSafely('create_orders');
    }
    
    public function update(User $user, Order $order): bool
    {
        // æ£€æŸ¥å›¢é˜Ÿå’Œæƒé™
        return $user->current_team_id === $order->team_id 
            && $user->hasPermissionToSafely('edit_orders');
    }
    
    public function delete(User $user, Order $order): bool
    {
        // åªæœ‰å›¢é˜Ÿæ‰€æœ‰è€…æˆ–æœ‰åˆ é™¤æƒé™çš„ç”¨æˆ·å¯ä»¥åˆ é™¤
        return $user->current_team_id === $order->team_id 
            && ($user->hasRole('owner') || $user->hasPermissionToSafely('delete_orders'));
    }
    
    public function approve(User $user, Order $order): bool
    {
        return $user->current_team_id === $order->team_id 
            && $user->hasPermissionToSafely('approve_orders');
    }
}

// åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨ç­–ç•¥
class OrderController extends Controller
{
    public function index()
    {
        $this->authorize('viewAny', Order::class);
        
        $user = auth()->user();
        $orders = Order::where('team_id', $user->current_team_id)->paginate(20);
        
        return view('orders.index', compact('orders'));
    }
    
    public function show(Order $order)
    {
        $this->authorize('view', $order);
        
        return view('orders.show', compact('order'));
    }
    
    public function update(Request $request, Order $order)
    {
        $this->authorize('update', $order);
        
        // æ›´æ–°è®¢å•é€»è¾‘
        $order->update($request->validated());
        
        return redirect()->route('orders.show', $order);
    }
}
```

### è¡¨å•è¯·æ±‚æƒé™éªŒè¯

```php
// åˆ›å»ºè¡¨å•è¯·æ±‚ç±»
class UpdateOrderRequest extends FormRequest
{
    public function authorize()
    {
        $user = auth()->user();
        $order = $this->route('order');
        
        // æ£€æŸ¥å›¢é˜Ÿæƒé™
        if ($user->current_team_id !== $order->team_id) {
            return false;
        }
        
        // æ£€æŸ¥ç¼–è¾‘æƒé™
        return $user->hasPermissionToSafely('edit_orders');
    }
    
    public function rules()
    {
        return [
            'title' => 'required|string|max:255',
            'description' => 'nullable|string',
            'status' => 'required|in:pending,processing,completed,cancelled',
            'priority' => 'required|in:low,medium,high,urgent'
        ];
    }
    
    public function messages()
    {
        return [
            'title.required' => 'è®¢å•æ ‡é¢˜ä¸èƒ½ä¸ºç©º',
            'status.required' => 'è®¢å•çŠ¶æ€ä¸èƒ½ä¸ºç©º',
            'status.in' => 'è®¢å•çŠ¶æ€å€¼æ— æ•ˆ',
        ];
    }
}

// åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨
public function update(UpdateOrderRequest $request, Order $order)
{
    // æƒé™éªŒè¯å·²åœ¨ FormRequest ä¸­å®Œæˆ
    $order->update($request->validated());
    
    return redirect()->route('orders.show', $order)
        ->with('success', 'è®¢å•æ›´æ–°æˆåŠŸ');
}
```

## ğŸ¨ å‰ç«¯æƒé™æ§åˆ¶

### Blade æ¨¡æ¿æƒé™æ£€æŸ¥

```php
{{-- æ£€æŸ¥æƒé™æ˜¾ç¤ºæŒ‰é’® --}}
@if(auth()->user()->hasPermissionToSafely('create_orders'))
    <a href="{{ route('orders.create') }}" class="btn btn-primary">
        åˆ›å»ºè®¢å•
    </a>
@endif

{{-- æ£€æŸ¥å¤šä¸ªæƒé™ --}}
@php
    $user = auth()->user();
    $canEdit = $user->hasPermissionToSafely('edit_orders');
    $canDelete = $user->hasPermissionToSafely('delete_orders');
@endphp

@if($canEdit || $canDelete)
    <div class="action-buttons">
        @if($canEdit)
            <a href="{{ route('orders.edit', $order) }}" class="btn btn-secondary">
                ç¼–è¾‘
            </a>
        @endif
        
        @if($canDelete)
            <form method="POST" action="{{ route('orders.destroy', $order) }}" 
                  style="display: inline;">
                @csrf
                @method('DELETE')
                <button type="submit" class="btn btn-danger" 
                        onclick="return confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ')">
                    åˆ é™¤
                </button>
            </form>
        @endif
    </div>
@endif

{{-- ä½¿ç”¨ç­–ç•¥æ£€æŸ¥ --}}
@can('update', $order)
    <a href="{{ route('orders.edit', $order) }}" class="btn btn-secondary">
        ç¼–è¾‘è®¢å•
    </a>
@endcan

@can('delete', $order)
    <button class="btn btn-danger" onclick="deleteOrder({{ $order->id }})">
        åˆ é™¤è®¢å•
    </button>
@endcan
```

### Vue.js æƒé™æ§åˆ¶

```javascript
// åˆ›å»ºæƒé™æ··å…¥
const permissionMixin = {
    methods: {
        hasPermission(permission) {
            return this.$store.getters.userPermissions.includes(permission);
        },
        
        hasAnyPermission(permissions) {
            return permissions.some(permission => this.hasPermission(permission));
        },
        
        hasAllPermissions(permissions) {
            return permissions.every(permission => this.hasPermission(permission));
        }
    }
};

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
export default {
    mixins: [permissionMixin],
    
    computed: {
        canCreateOrder() {
            return this.hasPermission('create_orders');
        },
        
        canManageOrders() {
            return this.hasAnyPermission(['edit_orders', 'delete_orders']);
        }
    },
    
    template: `
        <div>
            <button v-if="canCreateOrder" @click="createOrder">
                åˆ›å»ºè®¢å•
            </button>
            
            <div v-if="canManageOrders" class="order-actions">
                <button v-if="hasPermission('edit_orders')" @click="editOrder">
                    ç¼–è¾‘
                </button>
                <button v-if="hasPermission('delete_orders')" @click="deleteOrder">
                    åˆ é™¤
                </button>
            </div>
        </div>
    `
};
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æƒé™ç¼“å­˜ç­–ç•¥

```php
// åœ¨ç”¨æˆ·æ¨¡å‹ä¸­å®ç°æƒé™ç¼“å­˜
class User extends Authenticatable
{
    public function getCachedPermissions(): array
    {
        $cacheKey = "user_permissions_{$this->id}_{$this->current_team_id}";
        
        return Cache::remember($cacheKey, 1800, function() {
            $permissions = [];
            
            // è·å–ç”¨æˆ·åœ¨å½“å‰å›¢é˜Ÿçš„æ‰€æœ‰æƒé™
            foreach ($this->roles as $role) {
                $rolePermissions = $role->permissions->pluck('name')->toArray();
                $permissions = array_merge($permissions, $rolePermissions);
            }
            
            return array_unique($permissions);
        });
    }
    
    public function clearPermissionCache(): void
    {
        $cacheKey = "user_permissions_{$this->id}_{$this->current_team_id}";
        Cache::forget($cacheKey);
    }
    
    // é‡å†™æƒé™æ£€æŸ¥æ–¹æ³•ä½¿ç”¨ç¼“å­˜
    public function hasPermissionToSafely($permission, $guardName = null): bool
    {
        if (is_object($permission)) {
            return parent::hasPermissionToSafely($permission, $guardName);
        }
        
        $cachedPermissions = $this->getCachedPermissions();
        return in_array($permission, $cachedPermissions);
    }
}
```

### æ‰¹é‡æƒé™é¢„åŠ è½½

```php
// åœ¨æ§åˆ¶å™¨ä¸­é¢„åŠ è½½æƒé™æ•°æ®
class DashboardController extends Controller
{
    public function index()
    {
        $user = auth()->user();
        
        // é¢„åŠ è½½ç”¨æˆ·è§’è‰²å’Œæƒé™
        $user->load(['roles.permissions']);
        
        // æ‰¹é‡æ£€æŸ¥æƒé™
        $permissions = [
            'view_orders', 'create_orders', 'edit_orders', 'delete_orders',
            'view_products', 'create_products', 'edit_products', 'delete_products',
            'view_customers', 'create_customers', 'edit_customers', 'delete_customers'
        ];
        
        $userPermissions = [];
        foreach ($permissions as $permission) {
            $userPermissions[$permission] = $user->hasPermissionToSafely($permission);
        }
        
        return view('dashboard', compact('userPermissions'));
    }
}
```

é€šè¿‡è¿™äº›æƒé™ç®¡ç†æ–¹æ³•å’Œæœ€ä½³å®è·µï¼Œæ‚¨å¯ä»¥æ„å»ºä¸€ä¸ªå®‰å…¨ã€é«˜æ•ˆã€æ˜“ç»´æŠ¤çš„æƒé™ç³»ç»Ÿã€‚è®°ä½å§‹ç»ˆä½¿ç”¨å®‰å…¨æ–¹æ³•ï¼Œåˆç†åˆ©ç”¨ç¼“å­˜ï¼Œå¹¶åœ¨å‰ç«¯è¿›è¡Œé€‚å½“çš„æƒé™æ§åˆ¶ã€‚ 