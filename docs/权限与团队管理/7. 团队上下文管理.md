# å›¢é˜Ÿä¸Šä¸‹æ–‡ç®¡ç†

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†å›¢é˜Ÿä¸Šä¸‹æ–‡çš„æ¦‚å¿µã€ç®¡ç†æ–¹æ³•å’Œæœ€ä½³å®è·µã€‚

## ğŸ¯ å›¢é˜Ÿä¸Šä¸‹æ–‡æ¦‚å¿µ

### ä»€ä¹ˆæ˜¯å›¢é˜Ÿä¸Šä¸‹æ–‡ï¼Ÿ

å›¢é˜Ÿä¸Šä¸‹æ–‡æ˜¯æƒé™ç³»ç»Ÿä¸­çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼Œå®ƒå†³å®šäº†æƒé™æ“ä½œåœ¨å“ªä¸ªå›¢é˜Ÿçš„èŒƒå›´å†…æ‰§è¡Œã€‚åœ¨å¤šå›¢é˜Ÿç¯å¢ƒä¸­ï¼ŒåŒä¸€ä¸ªæƒé™åç§°å¯èƒ½åœ¨ä¸åŒå›¢é˜Ÿä¸­å¯¹åº”ä¸åŒçš„æƒé™å¯¹è±¡ã€‚

```php
// ç¤ºä¾‹ï¼šåŒåæƒé™åœ¨ä¸åŒå›¢é˜Ÿä¸­çš„æƒ…å†µ
// å›¢é˜Ÿ3çš„ 'view_orders' æƒé™ (ID: 1)
// å›¢é˜Ÿ5çš„ 'view_orders' æƒé™ (ID: 2) 
// å›¢é˜Ÿ10çš„ 'view_orders' æƒé™ (ID: 3)

// æ²¡æœ‰å›¢é˜Ÿä¸Šä¸‹æ–‡æ—¶ï¼Œç³»ç»Ÿå¯èƒ½æ‰¾åˆ°é”™è¯¯çš„æƒé™
$permission = Permission::where('name', 'view_orders')->first(); // æ€»æ˜¯è¿”å›ID=1çš„æƒé™

// æœ‰å›¢é˜Ÿä¸Šä¸‹æ–‡æ—¶ï¼Œç³»ç»Ÿæ‰¾åˆ°æ­£ç¡®çš„æƒé™
app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId(10);
$permission = Permission::where('name', 'view_orders')->first(); // è¿”å›ID=3çš„æƒé™
```

### ä¸ºä»€ä¹ˆéœ€è¦å›¢é˜Ÿä¸Šä¸‹æ–‡ï¼Ÿ

1. **æƒé™éš”ç¦»**ï¼šç¡®ä¿ç”¨æˆ·åªèƒ½æ“ä½œè‡ªå·±å›¢é˜Ÿçš„æƒé™
2. **æ•°æ®å®‰å…¨**ï¼šé˜²æ­¢è·¨å›¢é˜Ÿçš„æƒé™æ³„éœ²
3. **æ“ä½œå‡†ç¡®æ€§**ï¼šç¡®ä¿æƒé™æ“ä½œåœ¨æ­£ç¡®çš„å›¢é˜ŸèŒƒå›´å†…æ‰§è¡Œ
4. **ç³»ç»Ÿä¸€è‡´æ€§**ï¼šä¿æŒæƒé™ç³»ç»Ÿçš„é€»è¾‘ä¸€è‡´æ€§

## ğŸ”§ è‡ªåŠ¨å›¢é˜Ÿä¸Šä¸‹æ–‡

### ç³»ç»Ÿé»˜è®¤è¡Œä¸º

ç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨ç”¨æˆ·çš„ `current_team_id` ä½œä¸ºé»˜è®¤å›¢é˜Ÿä¸Šä¸‹æ–‡ï¼Œè¿™æ„å‘³ç€å¤§å¤šæ•°æƒ…å†µä¸‹æ‚¨æ— éœ€æ‰‹åŠ¨è®¾ç½®ã€‚

```php
// ç”¨æˆ·ç™»å½•åï¼Œç³»ç»Ÿè‡ªåŠ¨è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡
$user = auth()->user();
echo "ç”¨æˆ·å½“å‰å›¢é˜Ÿ: " . $user->current_team_id;

// æƒé™æ“ä½œè‡ªåŠ¨ä½¿ç”¨å½“å‰å›¢é˜Ÿä¸Šä¸‹æ–‡
$user->assignRoleSafely('creator'); // è‡ªåŠ¨åˆ†é…åˆ°ç”¨æˆ·å½“å‰å›¢é˜Ÿ
$user->hasPermissionToSafely('view_orders'); // è‡ªåŠ¨æ£€æŸ¥å½“å‰å›¢é˜Ÿçš„æƒé™
```

### setCurrentTeamAsPermissionContext()

æ‰‹åŠ¨è®¾ç½®ç”¨æˆ·å½“å‰å›¢é˜Ÿä¸ºæƒé™ä¸Šä¸‹æ–‡ã€‚

```php
$user = User::find(1);

// è®¾ç½®å½“å‰å›¢é˜Ÿä¸ºæƒé™ä¸Šä¸‹æ–‡
$user->setCurrentTeamAsPermissionContext();

// éªŒè¯è®¾ç½®ç»“æœ
$registrar = app(\Spatie\Permission\PermissionRegistrar::class);
$contextTeamId = $registrar->getPermissionsTeamId();

echo "ç”¨æˆ·å½“å‰å›¢é˜Ÿ: " . $user->current_team_id;
echo "æƒé™ä¸Šä¸‹æ–‡å›¢é˜Ÿ: " . $contextTeamId;

// é€šå¸¸è¿™ä¸¤ä¸ªå€¼åº”è¯¥ç›¸ç­‰
if ($user->current_team_id == $contextTeamId) {
    echo "å›¢é˜Ÿä¸Šä¸‹æ–‡è®¾ç½®æ­£ç¡®";
} else {
    echo "å›¢é˜Ÿä¸Šä¸‹æ–‡è®¾ç½®å¼‚å¸¸";
}
```

### ä¸­é—´ä»¶è‡ªåŠ¨è®¾ç½®

åˆ›å»ºä¸­é—´ä»¶è‡ªåŠ¨ä¸ºç™»å½•ç”¨æˆ·è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡ã€‚

```php
// app/Http/Middleware/SetUserTeamContext.php
class SetUserTeamContext
{
    public function handle($request, Closure $next)
    {
        if (auth()->check()) {
            $user = auth()->user();
            
            // ç¡®ä¿ç”¨æˆ·æœ‰å½“å‰å›¢é˜Ÿ
            if ($user->current_team_id) {
                $user->setCurrentTeamAsPermissionContext();
                
                Log::debug('è‡ªåŠ¨è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡', [
                    'user_id' => $user->id,
                    'team_id' => $user->current_team_id
                ]);
            } else {
                Log::warning('ç”¨æˆ·æ²¡æœ‰å½“å‰å›¢é˜Ÿ', [
                    'user_id' => $user->id
                ]);
            }
        }
        
        return $next($request);
    }
}

// åœ¨ app/Http/Kernel.php ä¸­æ³¨å†Œ
protected $middlewareGroups = [
    'web' => [
        // ... å…¶ä»–ä¸­é—´ä»¶
        \App\Http\Middleware\SetUserTeamContext::class,
    ],
];

// æˆ–è€…åœ¨ç‰¹å®šè·¯ç”±ç»„ä¸­ä½¿ç”¨
Route::middleware(['auth', 'set.team.context'])->group(function () {
    Route::resource('orders', OrderController::class);
    Route::resource('products', ProductController::class);
});
```

## ğŸ”„ ä¸´æ—¶å›¢é˜Ÿä¸Šä¸‹æ–‡åˆ‡æ¢

### withTeamContext() æ–¹æ³•

è¿™æ˜¯æ¨èçš„ä¸´æ—¶åˆ‡æ¢å›¢é˜Ÿä¸Šä¸‹æ–‡çš„æ–¹æ³•ï¼Œæ“ä½œå®Œæˆåä¼šè‡ªåŠ¨æ¢å¤åŸå§‹ä¸Šä¸‹æ–‡ã€‚

```php
$user = User::find(1);

// åœ¨å›¢é˜Ÿ7çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œæ“ä½œ
$result = $user->withTeamContext(7, function($user) {
    // åœ¨è¿™ä¸ªé—­åŒ…ä¸­ï¼Œæ‰€æœ‰æƒé™æ“ä½œéƒ½åœ¨å›¢é˜Ÿ7çš„ä¸Šä¸‹æ–‡ä¸­
    
    // æ£€æŸ¥æƒé™
    $canView = $user->hasPermissionToSafely('view_orders');
    $canEdit = $user->hasPermissionToSafely('edit_orders');
    
    // åˆ†é…è§’è‰²
    $user->assignRole('editor');
    
    // è·å–è§’è‰²
    $roles = $user->roles->pluck('name')->toArray();
    
    return [
        'can_view' => $canView,
        'can_edit' => $canEdit,
        'roles' => $roles
    ];
});

// æ“ä½œå®Œæˆåï¼Œå›¢é˜Ÿä¸Šä¸‹æ–‡è‡ªåŠ¨æ¢å¤åˆ°åŸå§‹çŠ¶æ€
echo "å›¢é˜Ÿ7æ“ä½œç»“æœ: " . json_encode($result, JSON_UNESCAPED_UNICODE);
```

### å¤æ‚çš„è·¨å›¢é˜Ÿæ“ä½œ

```php
// ç®¡ç†å‘˜æŸ¥çœ‹å¤šä¸ªå›¢é˜Ÿçš„æƒé™çŠ¶æ€
function getMultiTeamPermissionStatus(User $user, array $teamIds, array $permissions): array
{
    $results = [];
    
    foreach ($teamIds as $teamId) {
        $results[$teamId] = $user->withTeamContext($teamId, function($user) use ($permissions) {
            $teamPermissions = [];
            
            foreach ($permissions as $permission) {
                $teamPermissions[$permission] = $user->hasPermissionToSafely($permission);
            }
            
            return [
                'permissions' => $teamPermissions,
                'roles' => $user->roles->pluck('name')->toArray()
            ];
        });
    }
    
    return $results;
}

// ä½¿ç”¨ç¤ºä¾‹
$teamIds = [5, 7, 10];
$permissions = ['view_orders', 'edit_orders', 'delete_orders'];
$status = getMultiTeamPermissionStatus($user, $teamIds, $permissions);

foreach ($status as $teamId => $teamData) {
    echo "å›¢é˜Ÿ {$teamId}:\n";
    echo "  è§’è‰²: " . implode(', ', $teamData['roles']) . "\n";
    foreach ($teamData['permissions'] as $permission => $hasPermission) {
        echo "  {$permission}: " . ($hasPermission ? 'âœ“' : 'âœ—') . "\n";
    }
}
```

### æ‰¹é‡è·¨å›¢é˜Ÿæ“ä½œ

```php
// æ‰¹é‡è·¨å›¢é˜Ÿè§’è‰²åˆ†é…
class BatchTeamOperationService
{
    public function assignRoleToMultipleTeams(User $user, array $teamRoleMap): array
    {
        $results = [];
        
        foreach ($teamRoleMap as $teamId => $roles) {
            try {
                $result = $user->withTeamContext($teamId, function($user) use ($roles) {
                    // è·å–æ“ä½œå‰çš„è§’è‰²
                    $beforeRoles = $user->roles->pluck('name')->toArray();
                    
                    // åˆ†é…æ–°è§’è‰²
                    $user->assignRole($roles);
                    
                    // è·å–æ“ä½œåçš„è§’è‰²
                    $afterRoles = $user->roles->pluck('name')->toArray();
                    
                    return [
                        'before' => $beforeRoles,
                        'after' => $afterRoles,
                        'added' => array_diff($afterRoles, $beforeRoles)
                    ];
                });
                
                $results[$teamId] = [
                    'success' => true,
                    'data' => $result
                ];
                
            } catch (Exception $e) {
                $results[$teamId] = [
                    'success' => false,
                    'error' => $e->getMessage()
                ];
            }
        }
        
        return $results;
    }
    
    public function syncPermissionsAcrossTeams(User $user, array $teamPermissionMap): array
    {
        $results = [];
        
        foreach ($teamPermissionMap as $teamId => $permissions) {
            try {
                $result = $user->withTeamContext($teamId, function($user) use ($permissions) {
                    // æ¸…é™¤ç°æœ‰æƒé™
                    $user->permissions()->detach();
                    
                    // åˆ†é…æ–°æƒé™
                    $user->givePermissionTo($permissions);
                    
                    return [
                        'assigned_permissions' => $permissions,
                        'total_permissions' => count($permissions)
                    ];
                });
                
                $results[$teamId] = [
                    'success' => true,
                    'data' => $result
                ];
                
            } catch (Exception $e) {
                $results[$teamId] = [
                    'success' => false,
                    'error' => $e->getMessage()
                ];
            }
        }
        
        return $results;
    }
}

// ä½¿ç”¨æ‰¹é‡æ“ä½œæœåŠ¡
$batchService = new BatchTeamOperationService();

// æ‰¹é‡è§’è‰²åˆ†é…
$teamRoleMap = [
    5 => ['viewer'],
    7 => ['editor', 'approver'],
    10 => ['creator']
];

$roleResults = $batchService->assignRoleToMultipleTeams($user, $teamRoleMap);
foreach ($roleResults as $teamId => $result) {
    if ($result['success']) {
        echo "å›¢é˜Ÿ {$teamId} è§’è‰²åˆ†é…æˆåŠŸ\n";
        echo "  æ·»åŠ çš„è§’è‰²: " . implode(', ', $result['data']['added']) . "\n";
    } else {
        echo "å›¢é˜Ÿ {$teamId} è§’è‰²åˆ†é…å¤±è´¥: " . $result['error'] . "\n";
    }
}
```

## ğŸ” å›¢é˜Ÿä¸Šä¸‹æ–‡è°ƒè¯•

### è°ƒè¯•å›¢é˜Ÿä¸Šä¸‹æ–‡çŠ¶æ€

```php
// åˆ›å»ºå›¢é˜Ÿä¸Šä¸‹æ–‡è°ƒè¯•å™¨
class TeamContextDebugger
{
    public static function debugCurrentContext(): array
    {
        $registrar = app(\Spatie\Permission\PermissionRegistrar::class);
        $user = auth()->user();
        
        return [
            'user_id' => $user ? $user->id : null,
            'user_current_team_id' => $user ? $user->current_team_id : null,
            'permission_registrar_team_id' => $registrar->getPermissionsTeamId(),
            'context_matches' => $user && $user->current_team_id == $registrar->getPermissionsTeamId(),
            'timestamp' => now()->toDateTimeString()
        ];
    }
    
    public static function debugPermissionResolution(string $permissionName): array
    {
        $registrar = app(\Spatie\Permission\PermissionRegistrar::class);
        $currentTeamId = $registrar->getPermissionsTeamId();
        
        // æŸ¥æ‰¾æ‰€æœ‰åŒåæƒé™
        $allPermissions = \Spatie\Permission\Models\Permission::where('name', $permissionName)->get();
        
        // æŸ¥æ‰¾å½“å‰ä¸Šä¸‹æ–‡ä¸­çš„æƒé™
        $contextPermission = \Spatie\Permission\Models\Permission::where('name', $permissionName)
            ->where('team_id', $currentTeamId)
            ->first();
        
        return [
            'permission_name' => $permissionName,
            'current_team_context' => $currentTeamId,
            'all_permissions' => $allPermissions->map(function($p) {
                return [
                    'id' => $p->id,
                    'name' => $p->name,
                    'team_id' => $p->team_id,
                    'guard_name' => $p->guard_name
                ];
            })->toArray(),
            'context_permission' => $contextPermission ? [
                'id' => $contextPermission->id,
                'team_id' => $contextPermission->team_id
            ] : null,
            'resolution_correct' => $contextPermission !== null
        ];
    }
    
    public static function debugUserPermissions(User $user): array
    {
        $registrar = app(\Spatie\Permission\PermissionRegistrar::class);
        $originalContext = $registrar->getPermissionsTeamId();
        
        // è®¾ç½®ç”¨æˆ·å½“å‰å›¢é˜Ÿä¸ºä¸Šä¸‹æ–‡
        $user->setCurrentTeamAsPermissionContext();
        $userContext = $registrar->getPermissionsTeamId();
        
        // è·å–ç”¨æˆ·æƒé™
        $userPermissions = $user->getAllPermissions();
        $userRoles = $user->roles;
        
        // æ¢å¤åŸå§‹ä¸Šä¸‹æ–‡
        $registrar->setPermissionsTeamId($originalContext);
        
        return [
            'user_id' => $user->id,
            'user_current_team_id' => $user->current_team_id,
            'original_context' => $originalContext,
            'user_context' => $userContext,
            'context_set_correctly' => $user->current_team_id == $userContext,
            'roles_count' => $userRoles->count(),
            'roles' => $userRoles->map(function($r) {
                return [
                    'name' => $r->name,
                    'team_id' => $r->team_id
                ];
            })->toArray(),
            'permissions_count' => $userPermissions->count(),
            'permissions' => $userPermissions->map(function($p) {
                return [
                    'name' => $p->name,
                    'team_id' => $p->team_id
                ];
            })->toArray()
        ];
    }
}

// ä½¿ç”¨è°ƒè¯•å™¨
$contextInfo = TeamContextDebugger::debugCurrentContext();
echo "å½“å‰ä¸Šä¸‹æ–‡çŠ¶æ€: " . json_encode($contextInfo, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);

$permissionInfo = TeamContextDebugger::debugPermissionResolution('view_orders');
echo "æƒé™è§£æè°ƒè¯•: " . json_encode($permissionInfo, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);

$userInfo = TeamContextDebugger::debugUserPermissions($user);
echo "ç”¨æˆ·æƒé™è°ƒè¯•: " . json_encode($userInfo, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
```

### å›¢é˜Ÿä¸Šä¸‹æ–‡ç›‘æ§

```php
// åˆ›å»ºå›¢é˜Ÿä¸Šä¸‹æ–‡ç›‘æ§ä¸­é—´ä»¶
class TeamContextMonitor
{
    public function handle($request, Closure $next)
    {
        $startContext = $this->getCurrentContext();
        
        $response = $next($request);
        
        $endContext = $this->getCurrentContext();
        
        // æ£€æŸ¥ä¸Šä¸‹æ–‡æ˜¯å¦å‘ç”Ÿäº†æ„å¤–å˜åŒ–
        if ($startContext !== $endContext) {
            Log::warning('å›¢é˜Ÿä¸Šä¸‹æ–‡å‘ç”Ÿæ„å¤–å˜åŒ–', [
                'url' => $request->url(),
                'user_id' => auth()->id(),
                'start_context' => $startContext,
                'end_context' => $endContext,
                'user_agent' => $request->userAgent()
            ]);
        }
        
        return $response;
    }
    
    private function getCurrentContext(): ?int
    {
        $registrar = app(\Spatie\Permission\PermissionRegistrar::class);
        return $registrar->getPermissionsTeamId();
    }
}

// åˆ›å»ºå›¢é˜Ÿä¸Šä¸‹æ–‡æ—¥å¿—è®°å½•å™¨
class TeamContextLogger
{
    public static function logContextChange(string $operation, ?int $fromTeam, ?int $toTeam, array $extra = []): void
    {
        Log::info('å›¢é˜Ÿä¸Šä¸‹æ–‡å˜æ›´', array_merge([
            'operation' => $operation,
            'from_team' => $fromTeam,
            'to_team' => $toTeam,
            'user_id' => auth()->id(),
            'timestamp' => now()->toDateTimeString()
        ], $extra));
    }
    
    public static function logPermissionOperation(string $operation, string $permission, ?int $teamId, array $extra = []): void
    {
        Log::info('æƒé™æ“ä½œ', array_merge([
            'operation' => $operation,
            'permission' => $permission,
            'team_id' => $teamId,
            'user_id' => auth()->id(),
            'timestamp' => now()->toDateTimeString()
        ], $extra));
    }
}

// åœ¨ User æ¨¡å‹ä¸­é›†æˆæ—¥å¿—è®°å½•
class User extends Authenticatable
{
    public function withTeamContext(int $teamId, callable $callback)
    {
        $registrar = app(\Spatie\Permission\PermissionRegistrar::class);
        $originalTeamId = $registrar->getPermissionsTeamId();
        
        // è®°å½•ä¸Šä¸‹æ–‡åˆ‡æ¢
        TeamContextLogger::logContextChange('switch_to', $originalTeamId, $teamId);
        
        try {
            $registrar->setPermissionsTeamId($teamId);
            $registrar->forgetCachedPermissions();
            
            $result = $callback($this);
            
            return $result;
            
        } finally {
            $registrar->setPermissionsTeamId($originalTeamId);
            $registrar->forgetCachedPermissions();
            
            // è®°å½•ä¸Šä¸‹æ–‡æ¢å¤
            TeamContextLogger::logContextChange('restore_to', $teamId, $originalTeamId);
        }
    }
    
    public function hasPermissionToSafely($permission, $guardName = null): bool
    {
        $permissionName = is_string($permission) ? $permission : $permission->name;
        $currentTeamId = $this->getCurrentTeamId();
        
        // è®°å½•æƒé™æ£€æŸ¥
        TeamContextLogger::logPermissionOperation('check', $permissionName, $currentTeamId);
        
        return parent::hasPermissionToSafely($permission, $guardName);
    }
}
```

## âš ï¸ å¸¸è§é™·é˜±å’Œæ³¨æ„äº‹é¡¹

### 1. å¼‚æ­¥æ“ä½œä¸­çš„ä¸Šä¸‹æ–‡ä¸¢å¤±

```php
// âŒ é”™è¯¯ï¼šå¼‚æ­¥æ“ä½œä¸­ä¸Šä¸‹æ–‡å¯èƒ½ä¸¢å¤±
Queue::push(function() use ($user) {
    // è¿™é‡Œçš„å›¢é˜Ÿä¸Šä¸‹æ–‡å¯èƒ½ä¸æ­£ç¡®
    $user->assignRole('editor');
});

// âœ… æ­£ç¡®ï¼šåœ¨é˜Ÿåˆ—ä»»åŠ¡ä¸­æ˜ç¡®è®¾ç½®ä¸Šä¸‹æ–‡
class AssignRoleJob implements ShouldQueue
{
    protected $userId;
    protected $teamId;
    protected $role;
    
    public function __construct($userId, $teamId, $role)
    {
        $this->userId = $userId;
        $this->teamId = $teamId;
        $this->role = $role;
    }
    
    public function handle()
    {
        $user = User::find($this->userId);
        
        $user->withTeamContext($this->teamId, function($user) {
            $user->assignRole($this->role);
        });
    }
}

// åˆ†å‘ä»»åŠ¡
AssignRoleJob::dispatch($user->id, $user->current_team_id, 'editor');
```

### 2. åµŒå¥—ä¸Šä¸‹æ–‡åˆ‡æ¢

```php
// âŒ é¿å…ï¼šåµŒå¥—çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¯èƒ½å¯¼è‡´æ··ä¹±
$user->withTeamContext(5, function($user) {
    $user->withTeamContext(7, function($user) {
        // è¿™é‡Œçš„ä¸Šä¸‹æ–‡å¯èƒ½ä¸æ˜¯é¢„æœŸçš„
        $user->assignRole('editor');
    });
});

// âœ… æ¨èï¼šä½¿ç”¨å¹³é“ºçš„ä¸Šä¸‹æ–‡åˆ‡æ¢
$result1 = $user->withTeamContext(5, function($user) {
    return $user->hasPermissionToSafely('view_orders');
});

$result2 = $user->withTeamContext(7, function($user) {
    return $user->hasPermissionToSafely('view_orders');
});
```

### 3. ç¼“å­˜é—®é¢˜

```php
// å›¢é˜Ÿä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶éœ€è¦æ¸…é™¤æƒé™ç¼“å­˜
class User extends Authenticatable
{
    public function withTeamContext(int $teamId, callable $callback)
    {
        $registrar = app(\Spatie\Permission\PermissionRegistrar::class);
        $originalTeamId = $registrar->getPermissionsTeamId();
        
        try {
            $registrar->setPermissionsTeamId($teamId);
            
            // é‡è¦ï¼šæ¸…é™¤æƒé™ç¼“å­˜
            $registrar->forgetCachedPermissions();
            
            $result = $callback($this);
            
            return $result;
            
        } finally {
            $registrar->setPermissionsTeamId($originalTeamId);
            
            // é‡è¦ï¼šæ¢å¤æ—¶ä¹Ÿè¦æ¸…é™¤ç¼“å­˜
            $registrar->forgetCachedPermissions();
        }
    }
}
```

### 4. å¹¶å‘è®¿é—®é—®é¢˜

```php
// åœ¨é«˜å¹¶å‘ç¯å¢ƒä¸­ï¼Œä½¿ç”¨ç”¨æˆ·çº§åˆ«çš„ä¸Šä¸‹æ–‡ç®¡ç†
class UserTeamContextManager
{
    private static $userContexts = [];
    
    public static function setUserTeamContext(int $userId, int $teamId): void
    {
        self::$userContexts[$userId] = $teamId;
        
        // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·ï¼ŒåŒæ—¶è®¾ç½®å…¨å±€ä¸Šä¸‹æ–‡
        if (auth()->id() == $userId) {
            $registrar = app(\Spatie\Permission\PermissionRegistrar::class);
            $registrar->setPermissionsTeamId($teamId);
        }
    }
    
    public static function getUserTeamContext(int $userId): ?int
    {
        return self::$userContexts[$userId] ?? null;
    }
    
    public static function clearUserTeamContext(int $userId): void
    {
        unset(self::$userContexts[$userId]);
    }
}
```

## ğŸ“‹ æœ€ä½³å®è·µæ€»ç»“

1. **ä¾èµ–è‡ªåŠ¨ä¸Šä¸‹æ–‡**ï¼šè®©ç³»ç»Ÿè‡ªåŠ¨ä½¿ç”¨ç”¨æˆ·çš„ `current_team_id`
2. **ä½¿ç”¨ withTeamContext**ï¼šè¿›è¡Œä¸´æ—¶è·¨å›¢é˜Ÿæ“ä½œæ—¶ä½¿ç”¨æ­¤æ–¹æ³•
3. **é¿å…æ‰‹åŠ¨è®¾ç½®**ï¼šé™¤éå¿…è¦ï¼Œé¿å…ç›´æ¥æ“ä½œ PermissionRegistrar
4. **æ¸…é™¤ç¼“å­˜**ï¼šä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶è®°å¾—æ¸…é™¤æƒé™ç¼“å­˜
5. **è®°å½•æ—¥å¿—**ï¼šåœ¨å…³é”®çš„ä¸Šä¸‹æ–‡æ“ä½œä¸­è®°å½•æ—¥å¿—
6. **å¼‚å¸¸å¤„ç†**ï¼šç¡®ä¿ä¸Šä¸‹æ–‡åˆ‡æ¢æœ‰é€‚å½“çš„å¼‚å¸¸å¤„ç†
7. **æµ‹è¯•éªŒè¯**ï¼šç¼–å†™æµ‹è¯•éªŒè¯ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ­£ç¡®æ€§

é€šè¿‡æ­£ç¡®ç†è§£å’Œä½¿ç”¨å›¢é˜Ÿä¸Šä¸‹æ–‡ç®¡ç†ï¼Œæ‚¨å¯ä»¥ç¡®ä¿æƒé™ç³»ç»Ÿåœ¨å¤šå›¢é˜Ÿç¯å¢ƒä¸­çš„æ­£ç¡®æ€§å’Œå®‰å…¨æ€§ã€‚ 